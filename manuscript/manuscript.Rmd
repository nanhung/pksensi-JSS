---
author:
  - name: Nan-Hung Hsieh
    affiliation: Texas A&M University
  - name: Brad Reisfeld
    affiliation: Colorado State University 
  - name: Weihsueh A. Chiu
    affiliation: Texas A&M University
    address: >
      4458 TAMU, 
      College Station, TX 77843, USA
    email: \email{wchiu@cvm.tamu.edu}  
title:
  formatted: "\\pkg{pksensi}: An R package to apply sensitivity analysis in pharmacokinetic models"
  # If you use tex in the formatted title, also supply version without
  plain:     "pksensi: An R package an R package to apply sensitivity analysis in pharmacokinetic models"
  # For running headers, if needed
  short:     "**pksensi**: Sensitivity analysis for pharmacokinetic models in R"
abstract: >
  Sensitivity analysis is an essential tool for modelers to understand the influence of model parameters on model outputs. It is also increasingly used in developing and assessing pharmacokinetic models. In our previous work, we applied a global sensitivity analysis workflow to reduce the computational burden in the Bayesian Markov Chain Monte Carlo-based calibration process of a physiologically based pharmacokinetic (PBPK) model. Although several sensitivity analysis algorithms are available, no comprehensive package exists that allows users to seamlessly solve the PBPK model differential equations, run sensitivity analyses, visualize sensitivity analysis results, and discriminate between the “non-influential” model parameters that can be fixed and those that need calibration. Therefore, we developed an open-source R package, called **pksensi**, to fill this need and make sensitivity analysis more accessible in pharmacological and toxicological research. This package can investigate both parameter uncertainty and sensitivity in pharmacokinetic models, such as PBPK model with multivariate model outputs (multiple time-points and tissue compartments). It also refined the extended Fourier Amplitude Sensitivity Test method for sensitivity analysis by adding a random phase-shift to analyze the statistical variability of the sensitivity index for each model parameter. Furthermore, pksensi includes functions to check the convergence and sensitivity of model parameters, providing a means to assess the robustness of the sensitivity measurement. Utilizing pksensi, we successfully reproduced our previously published sensitivity analysis results of human PBPK modeling for acetaminophen and its two primary metabolites. Overall, pksensi improves the user experience of performing sensitivity analysis and can create robust and reproducible results for decision making in pharmacokinetic model calibration. 
keywords:
  # at least one keyword must be supplied
  formatted: [Pharmacokinetics, Physiologically based pharmacokinetics, Sensitivity analysis]
  plain:     [Pharmacokinetics, Physiologically based pharmacokinetics, Sensitivity analysis]
preamble: >
  \usepackage{amsmath}
bibliography: references.bib 
output: rticles::jss_article

---

# Introduction

Sensitivity analysis is a mathematical technique to investigate how variations in model parameters affect model outputs. An increasing number of studies use sensitivity analysis to determine which model parameters contribute to high variation in model predictions \citep{ferretti2016trends}. This technique has also been applied in pharmacology and toxicology research \citep{loizou2015application, mcnally2012reconstruction}. Pharmacokinetic modeling describes the changes in the concentrations or amounts of a substance within model compartments over time. The goal of sensitivity analysis in pharmacokinetic research is to examine the sensitivity of output variables (e.g. compound concentration in blood or tissues) in pharmacokinetic models responds to input parameters, such as anatomical, physiological, and kinetic constants \citep{mcnally2011workflow}. It can be further applied to parameter prioritization and parameter fixing before model calibration \citep{fphar201800588}.  

In our previous work \citep{fphar201800588}, we developed an approach to apply global sensitivity analysis workflow to reduce the computational burden in the Bayesian,  Markov Chain Monte Carlo (MCMC)-based calibration process of a physiologically based pharmacokinetic (PBPK) model. We used GNU MCSim \citep{JSSv002i09}, an effective simulation package for Bayesian population PBPK modeling, to calibrate the model. We found that the extended Fourier Amplitude Sensitivity Test (eFAST), a type of global sensitivity analysis algorithm, had the best balance of efficiency and accuracy for a complex, multi-compartment, multi-dataset, and multi-metabolite PBPK model. Also, we found some efficient visualization approaches that can be used to distinguish between “influential” and “non-influential” parameters. We also found a useful approach for communicating the parameter sensitivity in decision making.  

Most sensitivity analysis tools are constructed using scientific computing software, such as \proglang{GNU Octave}/\proglang{Matlab} \citep{pianosi2015matlab}, \proglang{python} \citep{herman2017salib}, and \proglang{R} \citep{iooss2017introduction}. Previously, we mainly used \proglang{R} with the \pkg{sensitivity} package \citep{R-sensitivity}, which is a practical tool to conduct local and global sensitivity analysis. The sensitivity package includes some functions to generate the parameter sequences by using different computing algorithms. Also, it provides a feasible way to integrate external modeling results. This computational approach can effectively solve the heavy computing burden of numerical solutions within the pure \proglang{R} environment. Several other \proglang{R} packages, such as \pkg{FME}, \pkg{multisensi}, and \pkg{ODEsensitivity} include sensitivity analysis tools and are freely available in the Comprehensive R Archive Network (CRAN). The \pkg{FME} package contains a basic method for performing local sensitivity analysis for dynamic models \citep{JSSv033i03}. The \pkg{multisensi} package provides sensitivity analysis for models with multivariate output \citep{R-multisensi}. \pkg{ODEsensitivity} can perform sensitivity analysis in ordinary differential equation (ODE) models \citep{R-ODEsensitivity}. It uses the ODE interface from the deSolve package, connecting it with the sensitivity analysis from the sensitivity package, and can perform sensitivity analysis on models with multivariate output. Other related packages such as \pkg{mtk} \citep{RJ-2015-031} and \pkg{fast} \citep{R-fast} are designed to investigate the influence of model parameter. Although these tools provide various approaches to perform sensitivity analysis, we have not found a suitable package that provides functions with which users can visualize and distinguish the “non-influential” model parameters and can further apply to parameter fixing in pharmacokinetic modeling.  
Wepresent here an \proglang{R} package, called \pkg{pksensi}, which is designed to make sensitivity analysis more accessible and reproducible in pharmacological and toxicological researches. This package can investigate both parameter uncertainty and sensitivity in pharmacokinetic models, such as PBPK, and advanced compartment absorption and transit models with multivariate model output. The design concepts of \pkg{pksensi} are:  

*	Cross-platform: Models can run on Windows/MacOS/Linux
*	Freely available: All related packages are free and open source
*	Integrated application: Users can run pharmacokinetic models in \proglang{R} with script that were written in \proglang{C} or \proglang{GNU MCSim} 
*	Decision making: The output results and visualization tools can be used to easily determine which parameters have "non-influential" effects on the model output and can be fixed in model calibration. 

# Workflow

## Installation

\pkg{pksensi} is available from the comprehensive R Archive Network at https://CRAN.R-project.org/package=pksensi. The latest up-to-date version is available through GitHub at https://github.com/nanhung/pksensi. 

## Parameter matrix generation

We adopted eFAST (extended Fourier Amplitude Sensitivity Test), a widely used global sensitivity analysis approach in biomathematical modeling, especially for ordinary differential equation-based dynamical models, in this package \citep{saltelli1999quantitative}. Most of the available eFAST functions, such as the algorithm to generate the parameter space and to set the sampling frequency, were sourced from the \proglang{R} \pkg{sensitivity} package \citep{R-sensitivity}. To test the convergence and robustness of the sensitivity measurement, we included a random phase-shift approach to replicate sampling from random starting points across parameter space. This can be written as:

$$ x_i = \frac{1}{2} + \frac{1}{\pi}\arcsin(\sin(\omega_is + \varphi_i)) $$

where $x_i$ is the nominal value of the i-th parameter, and $\omega_i$  is a vector giving the set of frequencies, one frequency for each parameter. The default set of frequencies is based on the study from \cite{saltelli1999quantitative}. The first frequency of the vector $\omega$ is assigned to each factor $x_i$ in turn (corresponding to the estimation of Sobol indices of first and total order, respectively). Through the random phase-shift, the robust result of the sensitivity measurement should be similar across replications under the same sample size.

To investigate the convergence of sensitivity indices, we adopted the exam approach proposed by \citep{sarrazin2016global}. This method quantitatively assesses convergence by computing the width of 95% confidence intervals for all parameters across all time-points and output variables. To integrate the random phase-shift with eFAST, we built the \code{rfast99} function, which can be used to perform the sensitivity test for the whole pharmacokinetic modeling process. The function \code{rfast99} in \pkg{pksensi} can sample and generate the testing parameter matrix based on a given argument of sample size n and probability distribution (e.g., mean/s.d. of normal distribution, meanlog/sdlog of log-normal distribution, and minimum/maximum of uniform distribution). The number of model evaluations is equal to the sample size times the number of model parameters.

## Pharmacokinetic modeling

The \pkg{pksensi} provides a useful function to solve ordinary differential equations in pharmacokinetic models using analytical and numerical approaches. The solution can be performed under the pure \proglang{R} programming environment by linking pksensi with the \pkg{deSolve} package \citep{JSSv033i09}. However, the most efficient way to achieve high computational speed is through compiled, lower-level languages, such as \proglang{FORTRAN}, \proglang{C}, or \proglang{C++}. The \pkg{pksensi} includes a function to compile and create dynamic-link libraries (.dll) on Windows and shared objects (.so) on Unix-liked systems (e.g., Linux and MacOS). This compiled file can load and execute through the build-in function in \proglang{R}. However, Windows users need to install Rtools or MinGW to compile the source code by using the GNU GCC compiler. More requirements are detailed in the study from \citep{soetaertr}.  The \proglang{C} implementation of the example model can be found as an example within \proglang{GNU MCSim} v6.0.1 \citep{JSSv002i09}. The \pkg{pksensi} can also link with \proglang{GNU MCSim} to compile the model code, used in solving each system of equations.

## Output visualization and decision making

The output of sensitivity analysis returns a list that contains the given time-points and values of all state variables (e.g., chemical concentrations in blood). This format is particularly suited for further graphical routines within \pkg{pksensi}. Also, a plot can can create time-dependent sensitivity measurements of first and total order effect for all parameters in one figure. Furthermore, \pkg{pksensi} includes functions to check the convergence and sensitivity of model parameters, providing a means to assess the robustness of the sensitivity measurement. We also developed a "cut-off"-based approach in this package to accurately distinguish between "influential" and "non-influential" parameters. Finally, \pkg{pksensi} includes numerous visualization tools for the effective investigation and communication of results in decision making. 

# Examples 

## One-compartment toxicokinetic model

```{r setup, include = FALSE}
library(pksensi)
options(xtable.comment = FALSE)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height=4, 
  fig.width=6
)
```

### Equations

In this example, we use a simple, one-compartment PBTK model from \pkg{httk} package \citep{JSSv079i04} to demonstrate how \pkg{pksensi} can be applied to physiologically based kinetic studies. The differential equations for this model is as:

$$\frac{dA_{gutlumen}}{dt} = -k_{gutabs} \cdot A_{gutlumen} + g(t)$$
$$\frac{dC_{rest}}{dt} = \frac{k_{gutabs}}{V_{dist}}-k_{elim} \cdot C_{rest}$$

where $A_{gutlumen}$ is the state variable that describes the quantity of compound in gut lumen (mol), $k_{gutabs}$ is the absorption rate constant that describes the chemical absorption from the gut lumen into gut tissue through first-order processes (/h), $V_{dist}$ is the volume of distribution (L), and $k_{elim}$ is the elimination rate constant (/h), which is equal to the total clearance divided by the volume of distribution. The time-dependent function $g(t)$ is used to describe the oral dosing schedule. $C_{rest}$ is the chemical concentration in plasma that can be used to compare with observed results in a pharmacokinetic experiment (mol/L). 

### Model implementations with R deSolve package

In the beginning, we need to pre-install \pkg{GNU MCSim} \citep{JSSv002i09} and related standard C compiler. The \pkg{GNU MCSim} can be installed by following the instruction in \pkg{GNU MCSim}’s manual on https://www.gnu.org/software/mcsim/mcsim.html or using the build-in function \code{mcsim_install()} in \pkg{pksensi}. The C compiler had installed in Linux or MacOS. The Windows user can install Rtools on https://cran.r-project.org/bin/windows/Rtools/ and set the working path of compiler before using this function. 

We first implemented one-compartment TK model in \proglang{R} by compiling the file written under the \pkg{GNU MCSim}'s model format. \pkg{pksensi} allows users select the preferred method to solve the pharmacokinetic model, either with the \pkg{deSolve} package or with \pkg{GNU MCSim} through the compile function. Running model under \pkg{GNU MCSim} native code can have faster speed to obtain the model outputs. This section demo how to conduct global sensitivity analysis with \pkg{deSolve} package. Then compare the computer time with \pkg{MCSim}.

The following \proglang{R} script will download the one-compartment PBTK model from https://github.com/nanhung/pksensi/blob/master/tests/1cpt.model:
```{r, eval=T}
pbtk1cpt_model()
```

After create the model file, use \code{compile_model()} to generate the file that has dynamic-link library (DLL) or share object (SO) extention and can be linked dynamically into an R session (\code{pbtk1cpt.dll} on Windows or \code{pbtk1cpt.so} on other systems) and \proglang{R} file (\code{pbtk1cpt_inits.R}) with default input parameters and initial state settings with the definition of \code{application = "R"}. 

```{r, eval=T}
mName <- "pbtk1cpt"
compile_model(mName, application = "R")
source(paste0(mName, "_inits.R"))
```

The parameter values and initial states can be customized to specify the properties and schedule for the given dosing scenario.

```{r, eval=T}
parms <- initParms()
parms["vdist"] <- 6.13
parms["ke"] <- 0.0228
parms["kgutabs"] <- 2.18
initState <- initStates(parms=parms)
initState["Agutlument"] <- 10
```

Here shows the giveb parameter value (\code{parms}), initial state conditions (\code{initStat}), and the output variable (\code{Outputs}) that need to specify in model solving.

```{r, eval=T}
parms
```

```{r, eval=T}
initState
```

```{r, eval=T}
Outputs
```

In the current setting, we assumed the initial condition of the intake chemical to be 10 mol. The \code{initParms} and \code{initStates} functions were used to customize the parameter values and the initial state that will be used in the \code{solve_fun()} function. These parameter value can be refered from the \pkg{httk} package, which includes physico-chemical and drug biological properties for over 500 chemicals. In this case, we used the parameter value of Bisphenol A in this example. The given \code{vdist}, \code{ke}, and \code{kgutabs} are 0.74, 0.28, and 2.18, respectively.

Through \code{ode} function in \pkg{deSolve} package, we can visualize the pharmacokinetic according to the given parameter conditions such as time points (\code{times}):

```{r, eval=T}
library(deSolve)
times <- seq(from = 0.01, to = 24.01, by = 1)
y <- ode(initState, times, func = "derivs", parms = parms, 
         dllname = mName, initfunc = "initmod", nout = 1, outnames = Outputs)
```

```{r, eval=T, fig.cap = 'Simulation results of one-compartment PBTK model.'}
plot(y)
```

To conduct sensitivity analysis for the parameters in one-compartment pharmacokinetic model in this case, we aim to quantify the impact of these three parameters on the chemical concentration in plasma during 24-hour time period post intake. We assume a uniform distribution for the estimate for each parameter with the coefficient of uncertainty within 50%. The parameter ranges are assumed to be (0.37, 1.12) for \code{vdist}, (0.0058, 0.0174) for \code{ke}, and (0.045, 0.136) for \code{kgutabs}. The sample number determines the robustness of the result of sensitivity analysis. Higher sample numbers can generate narrow confidence intervals for sensitivity measurements across different replications. However, they might cause heavy computational burden for complex models. Here we use a sample number of 400 with 20 replications:

```{r, eval=T}
LL <- 0.5 
UL <- 1.5
q <- "qunif"
q.arg <- list(list(min = parms["vdist"] * LL, max = parms["vdist"] * UL),
             list(min = parms["ke"] * LL, max = parms["ke"] * UL), 
             list(min = parms["kgutabs"] * LL, max = parms["kgutabs"] * UL)) 
set.seed(1234)
params <- c("vdist", "ke", "kgutabs")
x <- rfast99(params, n = 200, q = q, q.arg = q.arg, replicate = 20)
```

Because the pharmacokinetic model is being used to describe a continuous process for the chemical concentration over time, the sensitivity measurements can also show the time-dependent relationships for each model parameter. Here we define the output time points to examine the change of the parameter sensitivity over time. To solve the pharmacokinetic model through deSolve, we need to provide the details of the argument: 

```{r, eval=T}
out <- solve_fun(x, times, initState = initState,
               outnames = Outputs, dllname = mName)
```

To create the time-dependent sensitivity measurement, we set the time duration from 0.01 to 24.01 hours in the example. The \code{initParmsfun} is used to generate the sampling value for each parameter. The \code{outnames}, \code{dllname}, \code{func}, \code{initfunc} are based on the arguments from the ode function in \pkg{deSolve} package. The details of the model structure and these arguments are defined in \code{pbtk1comp.c}. and \code{pbtk1comp_inits.R}. Finally, the \code{tell2()} function is used to integrate the parameter values and the output results of numerical analysis that were generated and stored in variables x and y. The result of object x is an object of rfast99, which has specific \code{print()}, \code{plot()}, and \code{check()} method. The print function gives the sensitivity and convergence indices for main, interaction, and total order at each time point. In addition to print out the result of sensitivity analysis, the more efficient way to distinguish the influence of model parameter is to visualize them. The time-dependent sensitivity indices are shown in Figure 2. 

```{r, eval=T, fig.cap = 'Figure 2. Time-dependent sensitivity indices of the plasma concentration estimated from one-compartment PBTK model during 24-hour time period intake.'}
plot(out)
```

Here, we can find that \code{vdist} and \code{ke} are dominating the plasma concentration in the before and after 5-hour post chemical intake, respectively, representing that the elimination is a key parameter to dominate the plasma concentration. Besides, the \code{kgutabs} only plays a crucial role to determine the plasma concentration in the first hour. The relationship between concentration and the parameters can be plotted as follow (Figure 3): 

```{r, eval=T, fig.cap = 'Figure 3. The relationship between model parameter and estimated concentration under the time-point of 0.01, 2.01, and 24.01 hr'}
par(mfrow = c(3,3), mar = c(2,2,2,2), oma = c(2,2,1,1))
plot(x$a[,1,"vdist"], out$y[,1,"0.01",], main = "vdist")
text(1, .7, "t=0.01",cex = 1.2)
plot(x$a[,1,"ke"], out$y[,1,"0.01",], main = "ke")
plot(x$a[,1,"kgutabs"], out$y[,1,"0.01",], main = "kgutabs")
plot(x$a[,1,"vdist"], out$y[,1,"2.01",])
text(1, 18, "t=2.01",cex = 1.2)
plot(x$a[,1,"ke"], out$y[,1,"2.01",])
plot(x$a[,1,"kgutabs"], out$y[,1,"2.01",])
plot(x$a[,1,"vdist"], out$y[,1,"24.01",])
text(1, .7, "t=24.01",cex = 1.2)
plot(x$a[,1,"ke"], out$y[,1,"24.01",])
plot(x$a[,1,"kgutabs"], out$y[,1,"24.01",])
mtext("parameter", SOUTH<-1, line=0.4, outer=TRUE)
mtext("Ccompartment", WEST<-2, line=0.4, outer=TRUE)
```

The \code{x} is a list of class \code{rfast99}, containing all the input arguments detailed before and the calculated sensitivity indices of first order (\code{mSI}), interaction (\code{iSI}), and total order (\code{tSI}). The convergence indices are also stored in the list named \code{mCI}, \code{iCI}, and \code{tCI}. The parameter values are stored in an array \code{x$a} with c(model evaluation, replication, parameters).

```{r, eval=T}
dim(x$a)
```

In addition, the output are also formated with c(model evaluation, replication, time, variable).

```{r, eval=T}
dim(out$y)
```

The \code{check()} is a useful function to determine which parameters have relative lower sensitivity measurement across the given time interval, and therefore can be applied parameter fixing in model calibration. The argument of \code{SI.cutoff} is setting at 0.5 to detect the relative non-influential parameters in this case. 

```{r, eval=T}
check(out, SI.cutoff = 0.5)
```

Based on the sensitivity measurement of the total order, the result shows that \code{kgutabs} has relative lower measurement of sensitivity index.

### Model implementations with GNU MCSim

Alternatively, to solve ODE by using \pkg{GNU MCSim}, we need to change the argument to \code{application = mcsim} in \code{compile_model()}. Rather than apply \pkg{deSolve} to solve differential equations, the \pkg{GNU MCSim} can provide higher computational speed in global sensitivity analysis.

```{r, eval=T}
system.time(out<-solve_fun(x, times, initState = initState, 
                         outnames = Outputs, dllname = mName))
```

```{r, eval=T}
compile_model(mName, application = "mcsim")
```

Similar to \code{solve_fun()} function that can define the initial parameter and state values through input function, the \code{solve_mcsim()} has a `condition` argument that is used to givien the specific input value such as oral dose or fixing parameter value or initial state variable.

```{r, eval=T}
conditions <- c("Agutlument = 10") # Set the initial state of Agutlument = 10 
system.time(out <- solve_mcsim(x, mName = mName, 
                           params = params,
                           vars = Outputs,
                           time = times,
                           condition = conditions))
```

Under the same given condition, it takes 5-6 seconds (\pkg{deSolve}) and 1-2 seconds (\pkg{GNU MCSim})  to solve model. The \code{solve_mcsim()} shows the better computational performance than \code{solve_fun()} in \pkg{pksensi}. 

## Acetaminophen-PBPK model

### Uncertainty and sensitivity analysis

The aim of this section is to reproduce our previous published result \citep{fphar201800588} of global sensitivity analysis for acetaminophen PBPK model through \pkg{pksensi}. The model codes are included in this package and can be generated through \code{pbpk_apap_model()}. We applied the global sensitivity analysis workflow to the original published model with 21 model parameters [@s13318-015-0253-x]. The descriptions of each parameter and the sampling ranges are list in Table 1.

```{r, results='asis',message=FALSE,warning=FALSE, echo = F}
library(xtable)

#Nominal value
Tg <- log(0.23)
Tp <- log(0.033)
CYP_Km <- log(130)
SULT_Km_apap <- log(300)
SULT_Ki <- log(526)
SULT_Km_paps <- log(0.5)
UGT_Km <- log(6.0e3)
UGT_Ki <- log(5.8e4)
UGT_Km_GA <-log(0.5)
Km_AG <- log(1.99e4)
Km_AS <- log(2.29e4)

r <- 1.96 # exp(1.96)/exp(-1.96) ~ 50

x <- c("Tg", "Tp", "CYP\\_Km", "CYP\\_VmaxC",
       "SULT\\_Km\\_apap","SULT\\_Ki","SULT\\_Km\\_paps","SULT\\_VmaxC",
       "UGT\\_Km","UGT\\_Ki","UGT\\_Km\\_GA","UGT\\_VmaxC",
       "Km\\_AG","Vmax\\_AG","Km\\_AS","Vmax\\_AS",
       "kGA\\_syn","PAPS\\_syn", "CLC\\_APAP","CLC\\_AG","CLC\\_AS"
       )

y <- c("Gatric emptying time constant",
       "GI perfusion time constant",
       "Cytochrome P450 metabolism, Km",
       "Cytochrome P450 metabolism, VMax",
       "Sulfation pathway acetaminophen, Km",
       "Sulfation pathway substrate inhibition, Ki",
       "Sulfation pathway PAPS, Km",
       "Sulfation pathway acetaminophen, Vmax",
       "Glucronidation pathway acetaminophen, Km",
       "Glucronidation pathway substrate inhibition, Ki",
       "Glucronidation pathway GA, Km",
       "Glucronidation pathway acetaminophen, Vmax",
       "APAP-G hepatic transporter, Km",
       "APAP-G hepatic transporter, Vmax",
       "APAP-S hepatic transporter, Km",
       "APAP-S hepatic transporter, Vmax",
       "UDPGA synthesis",
       "PAPS synthesis",
       "APAP clearance",
       "APAP-G clearance",
       "APAP-S clearance"
       )

z <- c("$h$", "$h$", "$\\mu{M}$", "$\\mu{mole}/h\\cdot{BW}^{0.75}$",
       "$\\mu{M}$", "$\\mu{M}$", "$-$", "$\\mu{mole}/h\\cdot{BW}^{0.75}$",
       "$\\mu{M}$", "$\\mu{M}$", "$-$", "$\\mu{mole}/h\\cdot{BW}^{0.75}$",
       "$\\mu{M}$", "$\\mu{mole}/h$", "$\\mu{M}$", "$\\mu{mole}/h$",
       "$1/h$", "$1/h$",
       "$L/h\\cdot{BW}^{0.75}$", "$L/h\\cdot{BW}^{0.75}$", "$L/h\\cdot{BW}^{0.75}$"
       )

min <- c(round(Tg-r, 3), round(Tp-r, 3), round(CYP_Km-r), round(log(0.14), 3),
         round(SULT_Km_apap-r, 3), round(SULT_Ki-r, 3), round(SULT_Km_paps-r), log(1),
         round(UGT_Km-r, 3), round(UGT_Ki-r, 3), round(UGT_Km_GA-r), log(1),
         round(Km_AG-r, 3), round(log(1.09e3), 3), round(Km_AS-r), round(log(1.09e3), 3),
         log(1), log(1), round(log(2.48e-3), 3), round(log(2.48e-3), 3), round(log(2.48e-3), 3)
         )

max <- c(round(Tg+r, 3), round(Tp+r, 3), round(CYP_Km+r), round(log(2900), 3),
         round(SULT_Km_apap+r, 3), round(SULT_Ki+r, 3), round(SULT_Km_paps+r), round(log(22026), 3),
         round(UGT_Km+r, 3), round(UGT_Ki+r, 3), round(UGT_Km_GA+r), round(log(22026), 3),
         round(Km_AG+r, 3), round(log(3.26e6), 3), round(Km_AS+r), round(log(3.26e6), 3),
         round(log(4.43e5), 3), round(log(4.43e5),3), 
         round(log(2.718), 3), round(log(2.718), 3), round(log(2.718), 3)
         )

df <- data.frame(x, y, z, min, max)
names(df) <- c("Parameter","Description", "Unit", "Min", "Max")

print(xtable(df, caption = "Description of sampling range of model parameter"),
      type = "latex", 
      caption.placement = "top", include.rownames = FALSE,
      sanitize.text.function = function(x) {x})
```

Same as the example of one-compartment PBTK model. The model parameter and the corresponding sampling range should be defined to create the parameter matrix. Previously, the probability distributions of model parameters were set to either truncated normal or uniform distribution when the parameters have informative prior information or not. To rapidly reach the acceptance convergence, we apply uniform distribution for all testing parameters. The ranges of informative parameters are set to 1.96-times difference for single side (approximate 54.6 times difference between minimum and maximum) under log-scaled. The nominal values of informative model parameters were defined as:

```{r, eval=T}
# Nominal value
Tg <- log(0.23)
Tp <- log(0.033)
CYP_Km <- log(130)
SULT_Km_apap <- log(300)
SULT_Ki <- log(526)
SULT_Km_paps <- log(0.5)
UGT_Km <- log(6.0e3)
UGT_Ki <- log(5.8e4)
UGT_Km_GA <-log(0.5)
Km_AG <- log(1.99e4)
Km_AS <- log(2.29e4)

rng <- 1.96 
```

Generally, The wide range of parameter value might cause the computational error in the solver. One of the effective ways to prevent this problem is to adjust the value of relative and absolute error tolerance to control the error appearance by resetting these parameters in a lower value. The \code{generate_infile()} provide the arguments of \code{rtol} and \code{atol} that can be adjusted to prevent the unwanted error. However, the modification will slow down the computational speed. Therefore, the alternative method to prevent the computational error is to detect the crucial parameter range that causes the problem. Also, setting the maximum number of (internally defined) steps to higher value instead of using the default value (500) can prevent this problem. The maximum number of step is set to 5000 in this case.

In this test case, we adjusted the range of \code{SULT_VmaxC} and \code{UGT_VmaxC} from U(0, 15) to U(0, 10). The relative and absolute error tolerance were set to 1e-7 and 1e-9, respectively, to prevent the computational error in \pkg{GNU MCSim},

```{r, eval=T}
params <- c("lnTg", "lnTp", "lnCYP_Km","lnCYP_VmaxC",
           "lnSULT_Km_apap","lnSULT_Ki","lnSULT_Km_paps","lnSULT_VmaxC",
           "lnUGT_Km","lnUGT_Ki","lnUGT_Km_GA","lnUGT_VmaxC",
           "lnKm_AG","lnVmax_AG","lnKm_AS","lnVmax_AS",
           "lnkGA_syn","lnkPAPS_syn", "lnCLC_APAP","lnCLC_AG","lnCLC_AS")
q <- "qunif"
q.arg <-list(list(Tg-rng, Tg+rng),
             list(Tp-rng, Tp+rng),
             list(CYP_Km-rng, CYP_Km+rng),
             list(-2., 5.),
             list(SULT_Km_apap-rng, SULT_Km_apap+rng),
             list(SULT_Ki-rng, SULT_Ki+rng),
             list(SULT_Km_paps-rng, SULT_Km_paps+rng),
             list(0, 10),
             list(UGT_Km-rng, UGT_Km+rng),
             list(UGT_Ki-rng, UGT_Ki+rng),
             list(UGT_Km_GA-rng, UGT_Km_GA+rng),
             list(0, 10),
             list(Km_AG-rng, Km_AG+rng),
             list(7., 15),
             list(Km_AS-rng, Km_AS+rng),
             list(7., 15),
             list(0., 13),
             list(0., 13),
             list(-6., 1),
             list(-6., 1),
             list(-6., 1))

times <- seq(from = 0.1, to = 12.1, by = 0.2)
set.seed(1234)
x <- rfast99(params = params, n = 512, q = q, q.arg = q.arg, replicate = 10) 
```

After creating the \code{pbpk_apap.model} file in the working directory, the next step is to generate the executable files (\code{mcsim.pbpk_apap}) through \code{compile_model()}. 

```{r, eval=T}
mName <- "pbpk_apap"
pbpk_apap_model()
compile_model(mName, application = "mcsim")
```

To improve the computational speed, this case only uses \pkg{GNU MCSim} to estimate the concentration of acetaminophen (APAP) and its metabolites glucuronide (AG) and sulfate (AS) in plasma. The setting oral dose of APAP is 20 mg/kg in this example. Generally, the input dosing method can be defined through the \code{condition} argument. Since the unit of the given dose is mg/kg, the \code{mgkg_flag} is set to 1 to declare the statement. More definition of input can be found in the section of input functions in \pkg{GNU MCSim} User’s Manual (https://www.gnu.org/software/mcsim/mcsim.html#Input-functions).

```{r, eval=T}
vars <- c("lnCPL_APAP_mcgL", "lnCPL_AG_mcgL", "lnCPL_AS_mcgL")
conditions <- c("mgkg_flag = 1",
                "OralExp_APAP = NDoses(2, 1, 0, 0, 0.001)",
                "OralDose_APAP_mgkg = 20.0")
generate_infile(params = params,
                vars = vars,
                time = times, 
                condition = conditions,
                rtol = 1e-7, atol = 1e-9)
system.time(out <- solve_mcsim(x, mName = mName, 
                             params = params,
                             vars = vars,
                             time = times,
                             condition = conditions,
                             generate.infile = F))
```

The plotting function can output the result of time-dependent sensitivity measurement to determine the parameter impact on model output over time (Figure 4). 

```{r, eval=T, fig.height=8, fig.width=8, fig.cap = ' '}
plot(out, vars = "lnCPL_AG_mcgL")
```

The uncertainty analysis is a crucial step before model calibration. We can apply uncertainty analysis through the `pksim()` by the given name of output variables (Figure 5). Through this visualization approach, we can recognize whether the simulated outputs can accurately simulate the same concentration profile as the in-vivo experiment under the setting of parameter ranges. In Figure 5, all experiment points are included in the intervals, representing the acceptable set of the parameter range. 

```{r, eval=T, fig.cap = ' '}
par(mfrow = c(2,2), mar = c(2,2,1,1), oma = c(2,2,1,1))
pksim(out$y, vars = "lnCPL_APAP_mcgL")
text(1, 15, "APAP",cex = 1.2)
points(APAP$Time, log(APAP$APAP * 1000))
pksim(out$y, vars = "lnCPL_AG_mcgL", legend = F)
text(1, 15, "AG",cex = 1.2)
points(APAP$Time, log(APAP$AG * 1000))
pksim(out$y, vars = "lnCPL_AS_mcgL", legend = F)
text(1, 15, "AS",cex = 1.2)
points(APAP$Time, log(APAP$AS * 1000))
mtext("Time", SOUTH<-1, line=0.4, cex=1.2, outer=TRUE)
mtext("Conc.", WEST<-2, line=0.4, cex=1.2, outer=TRUE)
```

In addition, through using the \code{check()}, the parameter with sensitivity and convergence indices over the given condition can be easily detected for all output variables.

```{r, eval=T}
check(out)
```

The \code{check()} also provides some feasible argument to specify the target output or change the cut-off value.

```{r, eval=T}
check(out, vars = "lnCPL_APAP_mcgL", SI.cutoff = 0.1, CI.cutoff = 0.1)
```

### Heatmap visualization combined with an index “cut-off”

Based on our previous study, we proposed the heatmap visualization approach to distinguish "influential" and "non-influential" parameters with a cut-off. Through the given argument \code{order}, we can select the specific order of sensitivity measurement that we're interested in (Figure 6 & 7). 

```{r, eval=T, fig.cap = ' '}
heat_check(out, order = "interaction")
```

```{r, eval=T, fig.cap = ' '}
heat_check(out, order = "total order")
```

Also, adding the `index = "CI"` in the function can further investigate the convergence of the sensitivity index. Based on the current setting of sampling number, most parameters cannot reach the acceptable criteria of convergence (Figure 8). Therefore, the higher number of sampling is necessary.

```{r, eval=T, fig.cap = ' '}
heat_check(out, index = "CI", CI.cutoff = 0.05, order = "total order")
```

# Concluding remarks

# Acknowledgments

This work was funded, in part, by grant 1U01FD005838 from the U.S. FDA.  This abstract reflects the views of the author and should not be construed to represent FDA’s views or policies. We thank Dr. Yasha Hartberg and Dr. Barbara Gastel at the Texas A&M University for reviewing the manuscript and consultation.

# References

```{r, include=FALSE}
knitr::write_bib(c('sensitivity','FME', 'multisensi', 'ODEsensitivity', 'fast'))
```
